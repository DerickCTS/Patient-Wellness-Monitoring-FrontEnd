<div class="modal-header">
  <h2>Assign Wellness Plan</h2>
  <p>Assigning wellness plan for patient: <strong>{{ data.patientName }}</strong></p>
  <button mat-icon-button mat-dialog-close>
    <mat-icon>close</mat-icon>
  </button>
</div>

<div class="modal-content">
  <div *ngIf="!planTypeSelected()" class="plan-type-selection">
    <mat-card class="type-card" (click)="selectPlanType('template')">
      <mat-icon class="icon">description</mat-icon>
      <h3>Use Template</h3>
      <p>Choose from pre-defined wellness plan templates</p>
    </mat-card>
    <mat-card class="type-card" (click)="selectPlanType('scratch')">
      <mat-icon class="icon">edit</mat-icon>
      <h3>Create from Scratch</h3>
      <p>Create a custom wellness plan tailored to the patient</p>
    </mat-card>
  </div>

  <form *ngIf="planTypeSelected()" [formGroup]="planForm" class="plan-form" (ngSubmit)="submitPlan()">
    
    <mat-form-field *ngIf="planTypeSelected() === 'template'" appearance="outline" class="full-width-input">
      <mat-label>Select Template *</mat-label>
      <mat-select formControlName="PlanId" required (selectionChange)="onTemplateSelect()">
        <mat-option *ngFor="let template of templates" [value]="template.id">
          {{ template.name }} - {{ template.category }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="planForm.get('PlanId')?.hasError('required')">Template is required</mat-error>
    </mat-form-field>
    
    <mat-card *ngIf="selectedTemplate()" class="template-info-card">
      <h4>{{ selectedTemplate()!.name }}</h4>
      <p><strong>Category:</strong> {{ selectedTemplate()!.category }}</p>
      <p><strong>Goal:</strong> {{ selectedTemplate()!.goal }}</p>
    </mat-card>

    <div class="form-row" *ngIf="planTypeSelected() === 'scratch' || !selectedTemplate() || planForm.get('DetailsModified')?.value">
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Plan Name *</mat-label>
          <input matInput formControlName="PlanName" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Category *</mat-label>
          <mat-select formControlName="Category" required>
            <mat-option *ngFor="let cat of categories" [value]="cat">{{ cat }}</mat-option>
          </mat-select>
        </mat-form-field>
    </div>
    <div class="form-row" *ngIf="planTypeSelected() === 'scratch' || !selectedTemplate() || planForm.get('DetailsModified')?.value">
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Image URL (Optional)</mat-label>
          <input matInput formControlName="ImageUrl">
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Goal *</mat-label>
          <textarea matInput formControlName="Goal" rows="3" required></textarea>
        </mat-form-field>
    </div>

    <h3 class="section-title"><mat-icon>calendar_today</mat-icon> Schedule Details</h3>
    <div class="form-row">
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Frequency Count *</mat-label>
          <input matInput type="number" formControlName="FrequencyCount" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Frequency Unit *</mat-label>
          <mat-select formControlName="FrequencyUnit" required>
            <mat-option *ngFor="let unit of frequencyUnits" [value]="unit">{{ unit }}</mat-option>
          </mat-select>
        </mat-form-field>
    </div>
    <div class="form-row">
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>Start Date *</mat-label>
          <input matInput [matDatepicker]="startDatePicker" formControlName="StartDate" required>
          <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width-input">
          <mat-label>End Date *</mat-label>
          <input matInput [matDatepicker]="endDatePicker" formControlName="EndDate" required>
          <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
        </mat-form-field>
    </div>

    <div class="details-header">
      <h3 class="section-title">Plan Details</h3>
      <mat-slide-toggle *ngIf="planTypeSelected() === 'template'" 
                       formControlName="DetailsModified"
                       (change)="onDetailsModifiedToggle($event.checked)">
        Modify Template Details
      </mat-slide-toggle>
    </div>
    
    <mat-card class="details-card">
        <mat-tab-group animationDuration="0ms">
          <mat-tab *ngFor="let detailType of detailTypes; let i = index" [label]="detailType">
            <mat-form-field appearance="fill" class="full-width-input detail-input">
              <mat-label>{{ detailType }} *</mat-label>
              <textarea matInput [formControlName]="getDetailControlName(detailType)" rows="5" required></textarea>
              <mat-hint *ngIf="planTypeSelected() === 'template' && !planForm.get('DetailsModified')?.value">
                Read-only. Toggle "Modify Template Details" to edit.
              </mat-hint>
            </mat-form-field>
          </mat-tab>
        </mat-tab-group>
    </mat-card>

    <div class="modal-actions">
      <button mat-button type="button" (click)="planTypeSelected.set(null)">Back</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="planForm.invalid || isSubmitting()">
        <span *ngIf="isSubmitting()"><mat-spinner diameter="20"></mat-spinner> Assigning...</span>
        <span *ngIf="!isSubmitting()">{{ planTypeSelected() === 'template' ? 'Assign Template Plan' : 'Assign Custom Plan' }}</span>
      </button>
    </div>
  </form>
</div>