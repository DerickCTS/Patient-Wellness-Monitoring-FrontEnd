<mat-card *ngIf="isLoading">
  <mat-card-content><mat-progress-bar mode="indeterminate"></mat-progress-bar>Loading Patient Details...</mat-card-content>
</mat-card>

<div *ngIf="!isLoading && patientDetails">
  <div class="header-card">
    <div class="welcome-text">Welcome Doctor! <mat-icon>face</mat-icon></div>
  </div>
  
  <mat-card class="patient-info-card">
    <div class="profile-section">
      <img src="assets/profile-placeholder.jpg" alt="Patient Profile" class="profile-pic">
      <div class="profile-details">
        <span class="name">{{ patientDetails.firstName }} {{ patientDetails.lastName }}</span>
        <span class="email">{{ patientDetails.email }}</span>
      </div>
    </div>
    
    <div class="patient-data-grid">
      <div class="data-item"><strong>Gender</strong><span>{{ patientDetails.gender }}</span></div>
      <div class="data-item"><strong>Age</strong><span>{{ calculateAge(patientDetails.dateOfBirth) }}</span></div>
      <div class="data-item"><strong>Date Of Birth</strong><span>{{ patientDetails.dateOfBirth | date:'dd/MM/yyyy' }}</span></div>
      <div class="data-item"><strong>Blood Group</strong><span>{{ patientDetails.bloodGroup }}</span></div>
      
      <div class="data-item"><strong>Contact Number</strong><span>{{ patientDetails.contactNumber }}</span></div>
      <div class="data-item"><strong>Emergency Contact</strong><span>{{ patientDetails.emergencyContact }}</span></div>
      <div class="data-item"><strong>Address</strong><span>{{ patientDetails.address }}</span></div>
      <div class="data-item"><strong>Personalized Doctor</strong><span>{{ patientDetails.personalizedDoctor }}</span></div>
    </div>
  </mat-card>

  <div class="content-panels">
    <mat-card class="panel-card diagnoses-panel">
      <div class="panel-header">
        <mat-icon color="primary">favorite</mat-icon>
        <h3 class="panel-title">Diagnoses</h3>
      </div>
      <div class="panel-list">
        <div *ngFor="let diag of patientDetails.diagnoses; trackBy: trackByDiagnosis" 
             class="list-item" (click)="loadDiseaseDetails(diag.diagnosisId)">
          <div class="item-content">
            <strong>{{ diag.diseaseName }}</strong>
            <span class="sub-text">Dr. {{ diag.doctorName }} â€¢ {{ diag.diagnosisDate | date:'shortDate' }}</span>
          </div>
          <mat-icon>chevron_right</mat-icon>
        </div>
      </div>
    </mat-card>
    
    <mat-card class="panel-card medications-panel">
      <div class="panel-header">
        <mat-icon color="primary">medication</mat-icon>
        <h3 class="panel-title">Medications</h3>
      </div>
      <div class="panel-list">
        <div *ngFor="let med of patientDetails.medications; trackBy: trackByMedication" class="list-item">
          <div class="item-content">
            <strong>{{ med.medicationName }}</strong>
            <span class="sub-text">{{ med.dosage }} | Period: {{ med.startDate | date:'shortDate' }} to {{ med.endDate | date:'shortDate' }}</span>
          </div>
          <span class="tag" [class.active]="med.isActive" [class.inactive]="!med.isActive">
            {{ med.isActive ? 'Active' : 'Inactive' }}
          </span>
        </div>
      </div>
    </mat-card>
    
    <mat-card class="panel-card wellness-panel">
      <div class="panel-header">
        <mat-icon color="primary">spa</mat-icon>
        <h3 class="panel-title">Wellness Plan</h3>
        <button mat-flat-button color="primary" (click)="openAssignPlanModal()">+ New Plan</button>
      </div>
      <div class="panel-list">
        <div *ngFor="let plan of patientDetails.wellnessPlans; trackBy: trackByPlan" class="list-item">
          <div class="item-content">
            <strong>{{ plan.planName }}</strong>
            <span class="sub-text">{{ plan.frequencyCount }} {{ plan.frequencyUnit }}</span>
          </div>
          <span class="tag plan-tag" [class.custom]="plan.wellnessType === 'Custom'" [class.general]="plan.wellnessType === 'General'">
            {{ plan.wellnessType }}
          </span>
          <mat-icon>chevron_right</mat-icon>
        </div>
      </div>
    </mat-card>
  </div>

  <mat-card *ngIf="selectedDiagnosisDetails()" class="disease-details-card">
      <div class="header">
        <h3>{{ selectedDiagnosis()?.diseaseName }} Details</h3>
        <button mat-icon-button (click)="selectedDiagnosisDetails.set(null)">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <mat-tab-group animationDuration="0ms">
        <mat-tab label="Diagnosis">
          <p>{{ selectedDiagnosisDetails()?.diagnosisDescription }}</p>
        </mat-tab>
        <mat-tab label="Disease">
          <p>{{ selectedDiagnosisDetails()?.diseaseDescription }}</p>
        </mat-tab>
      </mat-tab-group>
  </mat-card>
</div>