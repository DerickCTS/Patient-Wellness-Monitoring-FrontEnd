<mat-card class="form-card" appearance="outlined">
  <form [formGroup]="prescriptionForm" (ngSubmit)="onSave()">
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-field">
          <mat-label>Medication Name *</mat-label>
          <input matInput formControlName="MedicationName" />
          <mat-error *ngIf="prescriptionForm.get('MedicationName')?.hasError('required')">
            Name is required
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-field">
          <mat-label>Dosage *</mat-label>
          <input matInput formControlName="Dosage" placeholder="e.g., 500mg" />
           <mat-error *ngIf="prescriptionForm.get('Dosage')?.hasError('required')">
            Dosage is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="flex-field">
          <mat-label>Start Date *</mat-label>
          <input
            matInput
            [matDatepicker]="startDatePicker"
            formControlName="StartDate"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="startDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
          <mat-error *ngIf="prescriptionForm.get('StartDate')?.hasError('required')">
            Start date is required
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="flex-field">
          <mat-label>End Date *</mat-label>
          <input
            matInput
            [matDatepicker]="endDatePicker"
            formControlName="EndDate"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="endDatePicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
          <mat-error *ngIf="prescriptionForm.get('EndDate')?.hasError('required')">
            End date is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="schedule-section">
        <div class="schedule-header">
          <h4>Medication Schedule</h4>
          <button
            mat-button
            type="button"
            color="primary"
            (click)="addSchedule()"
            [disabled]="schedules.length >= 5"
          >
            <mat-icon>add</mat-icon>
            Add Schedule
          </button>
        </div>
        
        <div *ngIf="schedules.controls.length === 0" class="schedule-empty-error">
           <mat-error>At least one schedule is required.</mat-error>
        </div>

        <div formArrayName="Schedules">
          <div
            *ngFor="let schedule of schedules.controls; let i = index"
            [formGroupName]="i"
            class="schedule-row"
          >
            <mat-form-field appearance="outline" class="schedule-field-time">
              <mat-label>Time</mat-label>
              <mat-select formControlName="TimeOfDay">
                <mat-option *ngFor="let time of timeOfDayOptions" [value]="time">
                  {{ time }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="schedule-field-qty">
              <mat-label>Qty</mat-label>
              <input matInput type="number" formControlName="Quantity" min="1" />
            </mat-form-field>

            <button
              mat-icon-button
              type="button"
              color="warn"
              (click)="removeSchedule(i)"
              [disabled]="schedules.length <= 1"
            >
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Special Instructions</mat-label>
        <textarea
          matInput
          formControlName="Instructions"
          rows="3"
          placeholder="e.g., Take with food, avoid alcohol..."
        ></textarea>
      </mat-form-field>
    </mat-card-content>

    <mat-card-actions align="end" class="form-actions">
      <button mat-button type="button" (click)="onCancel()">Cancel</button>
      <button mat-flat-button color="primary" type="submit">
        Save Medication
      </button>
    </mat-card-actions>
  </form>
</mat-card>